# Postmortem: Outage Checkout — Dezembro 2024

## Resumo
No dia 12/12/2024, o serviço de checkout ficou indisponível por 47 minutos entre 14:23 e 15:10 UTC. Impacto estimado: ~R$180k em vendas perdidas.

## Timeline
| Hora (UTC) | Evento |
|------------|--------|
| 14:15 | Deploy v2.14.3 do checkout (feature: novo cálculo de frete) |
| 14:20 | Primeiros erros 500 nos logs |
| 14:23 | Taxa de erro ultrapassa 5% — alerta PagerDuty dispara |
| 14:28 | On-call (Ana) reconhece o alerta, começa investigação |
| 14:35 | Identificado: NullPointerException no novo cálculo de frete |
| 14:38 | Decisão de rollback |
| 14:42 | Rollback iniciado: `kubectl rollout undo deployment/checkout` |
| 14:48 | Rollback completo, pods saudáveis |
| 14:55 | Taxa de erro volta ao baseline (< 0.1%) |
| 15:10 | Incidente resolvido, monitoramento confirmado |

## Causa Raiz
O novo endpoint de cálculo de frete (`/api/v2/shipping/calculate`) não tratava o caso em que o endereço do cliente não tinha CEP. A função `parseCEP()` retornava `null`, causando NullPointerException no cálculo subsequente.

**Código problemático:**
```java
String cep = address.getCep(); // retorna null se não preenchido
int zone = ShippingZone.fromCep(cep); // NullPointerException
```

## Fatores Contribuintes
1. Testes unitários não cobriam o caso de CEP nulo
2. Staging dataset não continha endereços sem CEP
3. Canary deploy não estava configurado para o checkout
4. Feature flag não foi usado para o novo cálculo

## Ações Corretivas
- [x] Fix do null check + testes (PR #1847)
- [x] Adicionar endereços edge-case ao staging dataset
- [ ] Configurar canary deploy para checkout (10% → 50% → 100%)
- [ ] Implementar feature flags para mudanças no fluxo de checkout
- [ ] Adicionar validação de entrada no API gateway

## Lições Aprendidas
1. Todo campo de endereço pode ser nulo — validar sempre
2. Canary deploy é essencial para serviços críticos
3. O rollback de 4 minutos salvou — investir em rollback rápido
